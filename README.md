# Category Sequential Permalinks (Fixed Version v3)

WordPressプラグイン「Category Sequential Permalinks」の修正版です。カテゴリ別連番で `/category-slug/番号/` 形式のパーマリンクを実現し、404/410エラー対応、動的リライトルール、削除時クリーンアップ機能を備えています。

## 概要

このプラグインは、WordPressの投稿にカテゴリ別の連番パーマリンクを提供します。主要カテゴリを基準に `/カテゴリ名/連番/` 形式のURLを生成し、SEOに優れた構造化されたURLを実現します。

## 主な機能

### 1. カテゴリ別連番パーマリンク
- 主要カテゴリを基準にした連番URL生成
- 手動での連番設定が可能
- 重複時の自動調整機能

### 2. 動的リライトルール
- 許可カテゴリのみにマッチする効率的な正規表現
- 存在しないカテゴリへの不要なマッチングを防止
- パフォーマンスの最適化

### 3. 包括的なエラーハンドリング
- 404エラーの網羅的な対応
- 410 Gone による不要URLの自然消滅促進
- リダイレクトエラーの適切な処理

### 4. 削除時クリーンアップ
- 投稿削除時の関連メタデータ自動削除
- カテゴリ削除時の連番メタクリーンアップ
- データベースの整合性維持

## インストール方法

1. プラグインファイルを `/wp-content/plugins/` ディレクトリにアップロード
2. WordPress管理画面でプラグインを有効化
3. 「設定 > パーマリンク」で「変更を保存」をクリック（リライトルールのフラッシュ）

## 設定

### 基本設定

```php
// 対象ポストタイプ
$csp_target_post_types = ['post'];

// 対象カテゴリの限定（空配列=全カテゴリ対象）
$csp_allowed_categories = []; // 例: ['news','column']

// スラッグ置換
$csp_slug_override = [
  'news' => 'topics', // 'news' を URL では 'topics' として表示
];
```

### 管理画面での操作

1. **投稿編集画面**で「カテゴリ別連番」メタボックスを確認
2. **主要カテゴリ**を選択（連番の基準となるカテゴリ）
3. **連番（手動）**で希望する番号を設定（空欄の場合は自動採番）

## 使用方法

### 自動採番
- カテゴリが設定された投稿を保存すると自動的に連番が付与されます
- 各カテゴリごとに独立した連番が管理されます

### 手動設定
- 管理画面のメタボックスで希望する連番を設定
- 重複する場合は自動的に次の空き番号に調整されます

### スラッグ置換
- 設定でカテゴリスラッグの置換が可能
- 実際のカテゴリスラッグと表示用URLを分離できます

## エラーハンドリング

### 404エラー対応
以下のURLパターンが自動的にホームページにリダイレクトされます：

- タグページの2階層以上: `/tag/タグ名/任意の文字列`
- カテゴリページの2階層以上: `/category/カテゴリ名/任意の文字列`
- カスタム投稿タイプの組み合わせ: `/投稿タイプ1/投稿タイプ2/任意の文字列`
- ページ/カスタム投稿タイプの組み合わせ: `/ページ名/投稿タイプ/任意の文字列`
- 検索ページ: `/search/任意の文字列`
- フィードページ: `/任意の文字列/feed/`

### 410 Gone対応
永続的に削除されたURLパターンには410 Goneを返します：

- タグページの2階層以上
- カテゴリページの2階層以上
- カスタム投稿タイプの2階層以上
- ページ/カスタム投稿タイプの2階層以上

### リダイレクト処理
- HTTPからHTTPSへの自動リダイレクト
- 末尾スラッシュの統一
- カテゴリ別連番の適切なリダイレクト

## 技術仕様

### データベース構造
- `_csp_primary_cat`: 主要カテゴリのterm_idを保存
- `cat_seq_{term_id}`: 各カテゴリの連番を保存

### リライトルール
```php
^({allowed_categories})/([0-9]+)/?$ → index.php?category_name=$matches[1]&cat_seq=$matches[2]
```

### フック
- `template_redirect`: リダイレクト処理
- `save_post`: 連番の自動採番
- `delete_post`: 削除時のクリーンアップ
- `delete_category`: カテゴリ削除時のクリーンアップ

## トラブルシューティング

### よくある問題

1. **リライトルールが反映されない**
   - 「設定 > パーマリンク」で「変更を保存」をクリック
   - プラグインを一度無効化して再有効化

2. **404エラーが発生する**
   - カテゴリが正しく設定されているか確認
   - 連番メタが保存されているか確認

3. **連番が重複する**
   - 手動設定時は重複チェックが自動実行されます
   - 既存データの修正が必要な場合は管理画面から手動調整

### デバッグ
- 404エラーは自動的にログに記録されます
- `error_log`でCSP関連のエラーを確認できます

## バージョン履歴

### v1.5.0 (Fixed v3)
- 動的リライトルールの実装
- 410 Gone対応の追加
- 包括的なエラーハンドリング
- 削除時クリーンアップ機能の強化

### v1.4.0 (Fixed v2)
- 404エラー対応の改善
- リダイレクト処理の追加
- 削除時の処理を実装

### v1.3.0 (Original)
- 基本的なカテゴリ別連番機能
- 手動連番設定機能
- 主要カテゴリ指定機能

## ライセンス

GPL v2 or later

## 作者

ShareMemori

## サポート

問題が発生した場合は、以下の情報とともにご連絡ください：

- WordPressのバージョン
- テーマ名
- 有効なプラグイン一覧
- エラーメッセージ（あれば）
- 発生している問題の詳細

## 注意事項

- このプラグインは既存のパーマリンク構造を変更します
- 本番環境での使用前に必ずテスト環境で動作確認を行ってください
- バックアップを取ってからインストールすることを強く推奨します
