# Category Sequential Permalinks - 技術仕様書

## 概要

WordPressプラグイン「Category Sequential Permalinks」は、カテゴリ別の連番パーマリンクを実現するプラグインです。主要カテゴリを基準に `/カテゴリ名/連番/` 形式のURLを生成し、SEOに優れた構造化されたURLを提供します。

## アーキテクチャ

### コア機能

1. **カテゴリ別連番パーマリンク生成**
   - 主要カテゴリを基準とした連番URL生成
   - 手動での連番設定機能
   - 重複時の自動調整機能

2. **動的リライトルール**
   - 許可カテゴリのみにマッチする効率的な正規表現
   - 存在しないカテゴリへの不要なマッチングを防止
   - パフォーマンスの最適化

3. **包括的なエラーハンドリング**
   - 404エラーの網羅的な対応
   - 410 Gone による不要URLの自然消滅促進
   - リダイレクトエラーの適切な処理

4. **削除時クリーンアップ**
   - 投稿削除時の関連メタデータ自動削除
   - カテゴリ削除時の連番メタクリーンアップ
   - データベースの整合性維持

### データベース構造

#### メタデータ
- `_csp_primary_cat`: 主要カテゴリのterm_idを保存
- `cat_seq_{term_id}`: 各カテゴリの連番を保存

#### リライトルール
```php
^({allowed_categories})/([0-9]+)/?$ → index.php?category_name=$matches[1]&cat_seq=$matches[2]
```

### フックシステム

#### WordPressフック
- `query_vars`: カスタムクエリ変数の追加
- `init`: リライトルールの登録
- `request`: URL解決処理
- `post_link`: パーマリンク生成
- `post_type_link`: カスタム投稿タイプのパーマリンク生成
- `template_redirect`: リダイレクト処理
- `save_post`: 連番の自動採番
- `delete_post`: 削除時のクリーンアップ
- `delete_category`: カテゴリ削除時のクリーンアップ
- `add_meta_boxes`: 管理画面メタボックスの追加
- `admin_init`: リライトルールのフラッシュ
- `wp`: 404エラーのログ記録

### 設定オプション

#### グローバル変数
```php
$csp_target_post_types = ['post']; // 対象ポストタイプ
$csp_allowed_categories = []; // 対象カテゴリの限定（空配列=全カテゴリ対象）
$csp_slug_override = []; // スラッグ置換設定
```

#### メタキー
```php
$csp_meta_primary_cat = '_csp_primary_cat'; // 主要カテゴリメタキー
$csp_meta_seq_prefix = 'cat_seq_'; // 連番メタプレフィックス
```

### エラーハンドリング

#### 404エラー対応
以下のURLパターンが自動的にホームページにリダイレクトされます：
- タグページの2階層以上
- カテゴリページの2階層以上
- カスタム投稿タイプの組み合わせ
- ページ/カスタム投稿タイプの組み合わせ
- 検索ページ
- フィードページ

#### 410 Gone対応
永続的に削除されたURLパターンには410 Goneを返します：
- タグページの2階層以上
- カテゴリページの2階層以上
- カスタム投稿タイプの2階層以上
- ページ/カスタム投稿タイプの2階層以上

### パフォーマンス最適化

1. **動的リライトルール**
   - 許可カテゴリのみにマッチする正規表現
   - 不要なマッチングを防止

2. **効率的なクエリ**
   - `no_found_rows` フラグの使用
   - `fields` パラメータで必要なデータのみ取得

3. **キャッシュ対応**
   - WordPressの標準キャッシュシステムを活用
   - メタデータの効率的な保存・取得

### セキュリティ

1. **入力値の検証**
   - `sanitize_title()` によるスラッグの検証
   - `intval()` による数値の検証
   - `wp_verify_nonce()` によるCSRF対策

2. **権限チェック**
   - 管理画面での適切な権限確認
   - 投稿編集権限の確認

### 互換性

#### WordPress要件
- WordPress 5.0以上
- PHP 7.4以上

#### テーマ互換性
- 標準WordPressテーマとの完全互換
- カスタムテーマでの動作保証

#### プラグイン互換性
- 主要SEOプラグインとの互換性
- キャッシュプラグインとの互換性

### トラブルシューティング

#### よくある問題
1. リライトルールが反映されない
2. 404エラーが発生する
3. 連番が重複する

#### デバッグ機能
- 404エラーのログ記録
- エラーメッセージの詳細表示

### 今後の拡張予定

1. **多言語対応**
   - 国際化（i18n）対応
   - 多言語URLサポート

2. **パフォーマンス向上**
   - データベースクエリの最適化
   - キャッシュ機能の強化

3. **管理機能の拡張**
   - バルク操作機能
   - インポート/エクスポート機能
